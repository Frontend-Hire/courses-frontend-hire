import { Steps, Callout } from 'nextra/components';

# Setup Testing

Testing is tedius. Testing is boring. Developers avoid it.

Testing is important. Testing is necessary. Developers need to do it.

Manual testing is expensive and time consuming. Automated testing is cheap and fast.

Also, there are not a lot of testing tutorials out there as much as there are tutorials on how to build a web app. 

This causes a lot of developers to avoid testing just because of their lack of understading of the process and the tools. Even I don't like testing as a frontend developer. But I have a system that works for me and I want to share it with you. 

But first, we need to setup our tools.

## Vitest

Since we are using Vite, we greatly benefit from a native testing solution which is Vitest. You can read more about [Why Vitest here](https://vitest.dev/guide/why.html). 

Most companies out there use Jest for testing. Luckily, Vitest is compatible with Jest.

Either way, we need to install Vitest first. Run the following command in your terminal:

```sh
npm install -D vitest
```

Let us test if Vitest is working. The following steps are directly taken from the docs [here](https://vitest.dev/guide/#writing-tests).

<Steps>
### Create a file called `sum.ts` inside the `src` folder. Paste the following code inside it:

```ts filename="./src/sum.ts"
export function sum(a: number, b: number) {
  return a + b
}
```

### Similarly, create a file called `sum.test.ts` inside the `src` folder. Paste the following code inside it:

```ts filename="./src/sum.test.ts"
import { expect, test } from 'vitest'
import { sum } from './sum'

test('adds 1 + 2 to equal 3', () => {
  expect(sum(1, 2)).toBe(3)
})
```

### Update yours `package.json` file to include the following script:

```json {7} filename="./package.json"
{
  // Rest of the file omitted for brevity

  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "test": "vitest",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "preview": "vite preview",
    "prepare": "husky install"
  },

  // Rest of the file omitted for brevity
}
```

### Run the following command in your terminal:

```sh
npm run test
```

And then, you should see something like this:
![Sample Test Output](./screenshots/setup-testing-1.png)

</Steps>

In fact, this little test we wrote is what we call a `unit test`. It is a test that tests a small unit of code. In this case, we are testing the `sum` function. 

These kinds of tests are very important because they test the small units of code that make up your app. 

Also, using a __TDD__ (Test Driven Development) approach is easier with unit tests. You can straight away write the unit tests and then write the code to make the tests pass.

Okay, now that we have Vitest setup. We just need one more tool to finish our setup.

## React Testing Library (RTL)

<Callout>
I would first highly recommend: 
- You read the guiding principles of testing library [here](https://testing-library.com/docs/guiding-principles).
- You read the blog post on __Testing Implementation Details__ by Kent C. Dodds [here](https://kentcdodds.com/blog/testing-implementation-details).

</Callout>

Either way, we need to install RTL so that we can test our React components. Run the following command in your terminal:

```sh
npm install -D @testing-library/react
```

This is not enough because we want to test certain things that are not possible with RTL. For example, we want to test if a certain element is visible or not. So, we need to install another library in the ecosystem called `jest-dom` which adds custom DOM element matchers ([read more here](https://testing-library.com/docs/ecosystem-jest-dom)). Run the following command in your terminal:

```sh
npm install -D @testing-library/jest-dom
```

In fact, these two are almost always used together.

Also, since we use Vitest and not Jest ([read more here](https://testing-library.com/docs/react-testing-library/setup#using-without-jest)), we have to install a test environment called `jsdom`. Run the following command in your terminal:

```sh
npm install -D jsdom
```

## Configuring Vitest and React Testing Library

Now that we have all the tools installed, we need to configure them. This is pretty simple and is usually only done once and never touched again.

But to figure out the actual configuration can be painful. I'd suggest going through the docs at a time when you are not tired and can focus on the task at hand.

The best part about configuring Vitest is that we can use our existing `vite.config.ts` file. We just need to add a few lines of code to it.

```ts {1, 8-12} filename="./vite.config.ts"
/// <reference types="vitest" />
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    globals: true,
    setupFiles: ['./test-setup.ts'],
  },
});
```

We got this configuration from the docs [here](https://vitest.dev/config/#configuring-vitest). 

We still have to create the `test-setup.ts` file. Create the file at the root of your project and paste the following code inside it:

```ts {1-7} filename="./test-setup.ts"
import { cleanup } from '@testing-library/react';
import '@testing-library/jest-dom/vitest';

// You'd see an error here due to TypeScript. We'll fix it in a moment.
afterEach(() => { 
  cleanup();
});
```

We added a comment for a potential error due to TypeScript. Now logically, this a correct error from TypeScript's perspective because where is this `afterEach` function coming from? We need to import it from somewhere. 

This actually comes from the `vitest` package and in our config file, we specified a property called `globals` which is set to `true`. This means that we want to use the functions provided by Vitest globally without importing them explicitly ([read more here](https://vitest.dev/config/#globals)).

We just have to tell TypeScript that this is the case. Just update your `tsconfig.json` file to include the following:

```json {5-6, 8-9} filename="./tsconfig.json"
{
  "compilerOptions": {
    // Some of the options omitted for brevity

    /* Testing */
    "types": ["vitest/globals"]
  },
  /* Since our test setup file is not inside the src folder, we need to include it here. */
  "include": ["src", "./test-setup.ts"], 
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

Great, everything is setup. Now, we can start writing our first real tests.